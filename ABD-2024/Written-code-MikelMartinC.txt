PermissionsTests.cs (1) : ﻿using System;
PermissionsTests.cs (2) : using System.Collections.Generic;
PermissionsTests.cs (3) : using System.Linq;
PermissionsTests.cs (4) : using System.Text;
PermissionsTests.cs (5) : using System.Threading.Tasks;
PermissionsTests.cs (6) : using Xunit;
PermissionsTests.cs (7) : using DbManager.Security;
PermissionsTests.cs (8) : using DbManager;
PermissionsTests.cs (10) : namespace OurTests
PermissionsTests.cs (11) : {
PermissionsTests.cs (13) : }
PermissionsTests.cs (14) : {
PermissionsTests.cs (15) : public class PermissionsTests
PermissionsTests.cs (16) : {
PermissionsTests.cs (17) : [Fact]
PermissionsTests.cs (18) : public void UsuarioNoAdminNoPuedeOtorgarPrivilegios()
PermissionsTests.cs (19) : {
PermissionsTests.cs (20) : var db = new Database("usuario1", "contrasena");
PermissionsTests.cs (22) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTests.cs (23) : db.ExecuteMiniSQLQuery("ADD USER (usuarioNoAdmin, contrasena, perfilNoAdmin)");
PermissionsTests.cs (24) : db.Save("BD_Privilegios");
PermissionsTests.cs (26) : Database dbNoAdmin = Database.Load("BD_Privilegios", "usuarioNoAdmin", "contrasena");
PermissionsTests.cs (27) : var resultado = dbNoAdmin.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTests.cs (28) : Assert.NotNull(resultado);
PermissionsTests.cs (30) : Assert.Equal(Constants.UsersProfileIsNotGrantedRequiredPrivilege, resultado);
PermissionsTests.cs (31) : }
PermissionsTests.cs (33) : [Fact]
PermissionsTests.cs (34) : public void AdminPuedeOtorgarPrivilegio()
PermissionsTests.cs (35) : {
PermissionsTests.cs (36) : var db = new Database("usuario", "password");
PermissionsTests.cs (38) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTests.cs (39) : db.ExecuteMiniSQLQuery("ADD USER (usuarioNoAdmin,password,perfilNoAdmin)");
PermissionsTests.cs (41) : var resultado = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTests.cs (43) : Assert.NotNull(resultado);
PermissionsTests.cs (44) : Assert.Equal(Constants.GrantPrivilegeSuccess, resultado);
PermissionsTests.cs (45) : }
PermissionsTests.cs (46) : [Fact]
PermissionsTests.cs (47) : public void NoSePuedeOtorgarDosVecesElMismoPrivilegio()
PermissionsTests.cs (48) : {
PermissionsTests.cs (49) : var db = new Database("usuario", "password");
PermissionsTests.cs (51) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTests.cs (52) : db.ExecuteMiniSQLQuery("ADD USER (usuarioNoAdmin,password,perfilNoAdmin)");
PermissionsTests.cs (53) : db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTests.cs (56) : var resultado = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTests.cs (58) : Assert.NotNull(resultado);
PermissionsTests.cs (59) : Assert.Equal(Constants.ProfileAlreadyHasPrivilege, resultado);
PermissionsTests.cs (60) : }
PermissionsTests.cs (62) : [Fact]
PermissionsTests.cs (63) : public void PerfilPuedeTenerMultiplesPrivilegios()
PermissionsTests.cs (64) : {
PermissionsTests.cs (65) : var db = new Database("admin", "adminpass");
PermissionsTests.cs (67) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfil");
PermissionsTests.cs (69) : var r1 = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfil");
PermissionsTests.cs (70) : var r2 = db.ExecuteMiniSQLQuery("GRANT INSERT ON tabla2 TO perfil");
PermissionsTests.cs (72) : Assert.Equal(Constants.GrantPrivilegeSuccess, r1);
PermissionsTests.cs (73) : Assert.Equal(Constants.GrantPrivilegeSuccess, r2);
PermissionsTests.cs (74) : }
PermissionsTests.cs (75) : [Fact]
PermissionsTests.cs (76) : public void AdminPuedeAnularPrivilegio()
PermissionsTests.cs (77) : {
PermissionsTests.cs (78) : var db = new Database("admin", "adminpass");
PermissionsTests.cs (80) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfil");
PermissionsTests.cs (81) : db.ExecuteMiniSQLQuery("GRANT DELETE ON tabla1 TO perfil");
PermissionsTests.cs (83) : var resultado = db.ExecuteMiniSQLQuery("REVOKE DELETE ON tabla1 FROM perfil");
PermissionsTests.cs (85) : Assert.Equal(Constants.RevokePrivilegeSuccess, resultado);
PermissionsTests.cs (86) : }
PermissionsTests.cs (88) : [Fact]
PermissionsTests.cs (89) : public void UsuarioNoAdminNoPuedeAnularPrivilegios()
PermissionsTests.cs (90) : {
PermissionsTests.cs (91) : var db = new Database("admin", "adminpass");
PermissionsTests.cs (93) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTests.cs (94) : db.ExecuteMiniSQLQuery("ADD USER (usuario, password, perfilNoAdmin)");
PermissionsTests.cs (95) : db.Save("BD_RevokeTest");
PermissionsTests.cs (97) : var dbNoAdmin = Database.Load("BD_RevokeTest", "usuario", "password");
PermissionsTests.cs (98) : var resultado = dbNoAdmin.ExecuteMiniSQLQuery("REVOKE INSERT ON tabla1 FROM perfilNoAdmin");
PermissionsTests.cs (100) : Assert.Equal(Constants.UsersProfileIsNotGrantedRequiredPrivilege, resultado);
PermissionsTests.cs (101) : }
PermissionsTests.cs (103) : }
PermissionsTests.cs (104) : }
ColumnDefinition.cs (33) : return value.Replace(Delimiter, DelimiterEncoded);
ColumnDefinition.cs (41) : return value.Replace(DelimiterEncoded, Delimiter);
ColumnDefinition.cs (58) : string[] parts = value.Split(Delimiter);
ColumnDefinition.cs (61) : if (parts.Length != 2)
ColumnDefinition.cs (62) : {
ColumnDefinition.cs (63) : return null;
ColumnDefinition.cs (64) : }
ColumnDefinition.cs (65) : string columnName = Decode(parts[0]);
ColumnDefinition.cs (67) : string typeString = Decode(parts[1]);
ColumnDefinition.cs (69) : DataType columnType;
ColumnDefinition.cs (71) : {
ColumnDefinition.cs (72) : columnType = DataType.String;
ColumnDefinition.cs (73) : }
ColumnDefinition.cs (75) : {
ColumnDefinition.cs (76) : columnType = DataType.Int;
ColumnDefinition.cs (77) : }
ColumnDefinition.cs (79) : {
ColumnDefinition.cs (80) : columnType = DataType.Double;
ColumnDefinition.cs (81) : }
ColumnDefinition.cs (82) : else
ColumnDefinition.cs (83) : {
ColumnDefinition.cs (85) : }
ColumnDefinition.cs (88) : return new ColumnDefinition(columnType, columnName);
Database.cs (34) : SecurityManager = new Manager(adminUsername);
Database.cs (35) : Profile profile = new Profile { Name = Profile.AdminProfileName };
Database.cs (36) : SecurityManager.Profiles.Add(profile);
Database.cs (37) : SecurityManager.ProfileByName(Profile.AdminProfileName).Users.Add(new User(adminUsername, adminPassword));
Database.cs (270) : if (!Directory.Exists(databaseName))
Database.cs (275) : foreach (Table table in Tables)
Database.cs (277) : string filePath = Path.Combine(databaseName, table.Name + TableFileExtension);
Database.cs (278) : using (StreamWriter writer = new StreamWriter(filePath))
Database.cs (281) : List<string> columnNames = new List<string>();
Database.cs (282) : for (int i = 0; i < table.NumColumns(); i++)
Database.cs (284) : columnNames.Add($"'{table.GetColumn(i).Name}'");
Database.cs (287) : writer.Write("[");
Database.cs (288) : writer.Write(string.Join(",", columnNames));
Database.cs (289) : writer.Write("]");
Database.cs (292) : for (int i = 0; i < table.NumRows(); i++)
Database.cs (294) : Row row = table.GetRow(i);
Database.cs (295) : List<string> values = row.Values.Select(v => $"'{v}'").ToList();
Database.cs (296) : writer.Write(" {" + string.Join(",", values) + "}");
Database.cs (299) : writer.WriteLine();
Database.cs (304) : this.SecurityManager.Save(Path.Combine(databaseName, "manager"));
Database.cs (308) : catch (Exception ex)
Database.cs (310) : Console.WriteLine("Error al guardar la base de datos: " + ex.Message);
Database.cs (325) : string[] tableFiles = Directory.GetFiles(Directory.GetCurrentDirectory(), databaseName + "_*" + TableFileExtension);
Database.cs (326) : if (tableFiles.Length == 0)
Database.cs (328) : Console.WriteLine(Constants.TableDoesNotExistError);
Database.cs (329) : return null;
Database.cs (330) : }
Database.cs (332) : Database db = new Database();
Database.cs (334) : db.m_username = username;
Database.cs (336) : for (int i = 0; i < tableFiles.Length; i++)
Database.cs (338) : string filePath = tableFiles[i];
Database.cs (339) : string tableName = Path.GetFileNameWithoutExtension(filePath).Replace(databaseName + "_", "");
Database.cs (340) : StreamReader reader = new StreamReader(filePath);
Database.cs (341) : try
Database.cs (343) : string tableData = reader.ReadLine();
Database.cs (344) : if (string.IsNullOrWhiteSpace(tableData))
Database.cs (346) : continue;
Database.cs (347) : }
Database.cs (349) : int startColumns = tableData.IndexOf('[') + 1;
Database.cs (350) : int endColumns = tableData.IndexOf(']');
Database.cs (351) : if (startColumns == 0 || endColumns == -1)
Database.cs (353) : continue;
Database.cs (356) : string[] columnNamesArray = tableData.Substring(startColumns, endColumns - startColumns).Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
Database.cs (357) : List<string> columnNames = new List<string>();
Database.cs (358) : for (int j = 0; j < columnNamesArray.Length; j++)
Database.cs (360) : columnNames.Add(columnNamesArray[j].Trim('\''));
Database.cs (363) : List<ColumnDefinition> columnDefinitions = new List<ColumnDefinition>();
Database.cs (364) : for (int j = 0; j < columnNames.Count; j++)
Database.cs (366) : columnDefinitions.Add(new ColumnDefinition(ColumnDefinition.DataType.String, columnNames[j]));
Database.cs (367) : }
Database.cs (369) : Table table = new Table(tableName, columnDefinitions);
Database.cs (371) : string rowsPart = tableData.Substring(endColumns + 1).Trim();
Database.cs (372) : while (!string.IsNullOrEmpty(rowsPart))
Database.cs (374) : int startRow = rowsPart.IndexOf('{');
Database.cs (375) : int endRow = rowsPart.IndexOf('}');
Database.cs (376) : if (startRow == -1 || endRow == -1 || startRow > endRow)
Database.cs (378) : break;
Database.cs (381) : string[] rowValuesArray = rowsPart.Substring(startRow + 1, endRow - startRow - 1).Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
Database.cs (382) : List<string> values = new List<string>();
Database.cs (383) : for (int j = 0; j < rowValuesArray.Length; j++)
Database.cs (385) : values.Add(rowValuesArray[j].Trim('\''));
Database.cs (388) : if (values.Count != columnDefinitions.Count)
Database.cs (390) : throw new FormatException("Row values do not match column count");
Database.cs (393) : table.AddRow(new Row(columnDefinitions, values));
Database.cs (394) : rowsPart = rowsPart.Substring(endRow + 1).Trim();
Database.cs (397) : db.Tables.Add(table);
Database.cs (398) : db.SecurityManager = Manager.Load(databaseName + "manager", username);
Database.cs (401) : finally
Database.cs (403) : reader.Close();
Database.cs (407) : if (db.SecurityManager.IsPasswordCorrect(username, password))
Database.cs (408) : {
Database.cs (409) : return db;
Database.cs (412) : return null;
Database.cs (414) : catch (Exception ex)
Database.cs (416) : Console.WriteLine("Error al cargar la base de datos: " + ex.Message);
Database.cs (472) : public void SetSecurityManager(Manager manager)
Database.cs (473) : {
Database.cs (474) : this.SecurityManager = manager;
Database.cs (475) : }
Row.cs (5) : using System.Runtime.CompilerServices;
Row.cs (29) : int position = -1;
Row.cs (31) : for (int i = 0; i < ColumnDefinitions.Count; i++)
Row.cs (33) : if (ColumnDefinitions[i].Name == columnName)
Row.cs (35) : position = i;
Row.cs (36) : break;
Row.cs (37) : }
Row.cs (38) : }
Row.cs (40) : if (position == -1)
Row.cs (41) : {
Row.cs (46) : while (Values.Count <= position)
Row.cs (47) : {
Row.cs (48) : Values.Add(null);
Row.cs (51) : Values[position] = value;
Row.cs (60) : int position = -1;
Row.cs (64) : if (ColumnDefinitions[i].Name == columnName)
Row.cs (66) : position = i;
Row.cs (67) : break;
Row.cs (71) : if (position == -1 || position >= Values.Count)
Row.cs (72) : {
Row.cs (76) : return Values[position];
Row.cs (77) : }
Row.cs (88) : for (int i = 0; i < ColumnDefinitions.Count; i++)
Row.cs (89) : {
Row.cs (90) : if (ColumnDefinitions[i].Name.Equals(condition.ColumnName))
Row.cs (91) : {
Row.cs (92) : return condition.IsTrue(Values[i], ColumnDefinitions[i].Type);
Row.cs (93) : }
Row.cs (94) : }
Row.cs (108) : return value.Replace(Delimiter, DelimiterEncoded);
Row.cs (118) : return value.Replace(DelimiterEncoded, Delimiter);
Row.cs (128) : String nuevo = "";
Row.cs (129) : int count = 1;
Row.cs (131) : {
Row.cs (132) : nuevo += Encode(valor);
Row.cs (133) : if (count!= Values.Count)
Row.cs (138) : count = count+1;
Row.cs (139) : }
Row.cs (149) : string[] valueArray = value.Split(Delimiter);
Row.cs (152) : List<string> values = new List<string>();
Row.cs (153) : foreach (string val in valueArray)
Row.cs (154) : {
Row.cs (155) : values.Add(Decode(val));
Row.cs (156) : }
Row.cs (159) : return new Row(columns, values);
ColumnDefinitionTests.cs (1) : using DbManager;
ColumnDefinitionTests.cs (9) : [Fact]
ColumnDefinitionTests.cs (10) : public void AsTextEncodeDecodeTest()
ColumnDefinitionTests.cs (11) : {
ColumnDefinitionTests.cs (12) : var column1 = new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre->Apellido");
ColumnDefinitionTests.cs (14) : Assert.Equal(column1.AsText(), ColumnDefinition.Parse(column1.AsText()).AsText());
ColumnDefinitionTests.cs (16) : var column2 = new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad->A�os");
ColumnDefinitionTests.cs (18) : Assert.Equal(column2.AsText(), ColumnDefinition.Parse(column2.AsText()).AsText());
ColumnDefinitionTests.cs (20) : var column3 = new ColumnDefinition(ColumnDefinition.DataType.Double, "Salario");
ColumnDefinitionTests.cs (22) : Assert.Equal(column3.AsText(), ColumnDefinition.Parse(column3.AsText()).AsText());
ColumnDefinitionTests.cs (24) : var column4 = new ColumnDefinition(ColumnDefinition.DataType.String, "Direcci�n->Calle 123");
ColumnDefinitionTests.cs (26) : Assert.Equal(column4.AsText(), ColumnDefinition.Parse(column4.AsText()).AsText());
ColumnDefinitionTests.cs (28) : var column5 = new ColumnDefinition(ColumnDefinition.DataType.Int, "N�mero->Casa 45");
ColumnDefinitionTests.cs (30) : Assert.Equal(column5.AsText(), ColumnDefinition.Parse(column5.AsText()).AsText());
ColumnDefinitionTests.cs (32) : var column6 = new ColumnDefinition(ColumnDefinition.DataType.Double, "Precio->123.45");
ColumnDefinitionTests.cs (34) : Assert.Equal(column6.AsText(), ColumnDefinition.Parse(column6.AsText()).AsText());
ColumnDefinitionTests.cs (36) : var column7 = new ColumnDefinition(ColumnDefinition.DataType.String, "TextoCon->Multiples->Delimitadores");
ColumnDefinitionTests.cs (38) : Assert.Equal(column7.AsText(), ColumnDefinition.Parse(column7.AsText()).AsText());
ColumnDefinitionTests.cs (40) : var column8 = new ColumnDefinition(ColumnDefinition.DataType.String, "Simple");
ColumnDefinitionTests.cs (42) : Assert.Equal(column8.AsText(), ColumnDefinition.Parse(column8.AsText()).AsText());
ColumnDefinitionTests.cs (43) : }
MiniSqlQueryTest.cs (1) : ﻿using System;
MiniSqlQueryTest.cs (2) : using System.Collections.Generic;
MiniSqlQueryTest.cs (3) : using System.IO;
MiniSqlQueryTest.cs (4) : using DbManager;
MiniSqlQueryTest.cs (5) : using DbManager.Parser;
MiniSqlQueryTest.cs (8) : namespace OurTests
MiniSqlQueryTest.cs (9) : {
MiniSqlQueryTest.cs (10) : public class MiniSqlQueryTest
MiniSqlQueryTest.cs (11) : {
MiniSqlQueryTest.cs (13) : [Fact]
MiniSqlQueryTest.cs (14) : public void InsertDatosValidos()
MiniSqlQueryTest.cs (15) : {
MiniSqlQueryTest.cs (17) : Database database = new Database(Database.AdminUsername, Database.AdminPassword);
MiniSqlQueryTest.cs (18) : List<ColumnDefinition> columnas = new List<ColumnDefinition>
MiniSqlQueryTest.cs (19) : {
MiniSqlQueryTest.cs (20) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
MiniSqlQueryTest.cs (21) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad")
MiniSqlQueryTest.cs (22) : };
MiniSqlQueryTest.cs (23) : Table tabla = new Table("Usuarios", columnas);
MiniSqlQueryTest.cs (24) : database.AddTable(tabla);
MiniSqlQueryTest.cs (25) : List<string> valores = new List<string> { "Juan Pérez", "30" };
MiniSqlQueryTest.cs (26) : Insert insertQuery = new Insert("Usuarios", valores);
MiniSqlQueryTest.cs (29) : string resultado = insertQuery.Execute(database);
MiniSqlQueryTest.cs (32) : Assert.Equal(Constants.InsertSuccess, resultado);
MiniSqlQueryTest.cs (33) : }
MiniSqlQueryTest.cs (35) : [Fact]
MiniSqlQueryTest.cs (36) : public void InsertCantidadInvalidaDeColumnas()
MiniSqlQueryTest.cs (37) : {
MiniSqlQueryTest.cs (39) : Database database = new Database(Database.AdminUsername, Database.AdminPassword);
MiniSqlQueryTest.cs (40) : List<ColumnDefinition> columnas = new List<ColumnDefinition>
MiniSqlQueryTest.cs (41) : {
MiniSqlQueryTest.cs (42) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
MiniSqlQueryTest.cs (43) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad")
MiniSqlQueryTest.cs (44) : };
MiniSqlQueryTest.cs (45) : Table tabla = new Table("Usuarios", columnas);
MiniSqlQueryTest.cs (46) : database.AddTable(tabla);
MiniSqlQueryTest.cs (47) : List<string> valores = new List<string> { "Juan Pérez" };
MiniSqlQueryTest.cs (48) : Insert insertQuery = new Insert("Usuarios", valores);
MiniSqlQueryTest.cs (51) : string resultado = insertQuery.Execute(database);
MiniSqlQueryTest.cs (54) : Assert.Equal(Constants.ColumnCountsDontMatch, resultado);
MiniSqlQueryTest.cs (55) : }
MiniSqlQueryTest.cs (56) : [Fact]
MiniSqlQueryTest.cs (57) : public void DropTableTablaExistente()
MiniSqlQueryTest.cs (58) : {
MiniSqlQueryTest.cs (60) : Database database = new Database(Database.AdminUsername, Database.AdminPassword);
MiniSqlQueryTest.cs (61) : List<ColumnDefinition> columnas = new List<ColumnDefinition>
MiniSqlQueryTest.cs (62) : {
MiniSqlQueryTest.cs (63) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
MiniSqlQueryTest.cs (64) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad")
MiniSqlQueryTest.cs (65) : };
MiniSqlQueryTest.cs (66) : Table tabla = new Table("Usuarios", columnas);
MiniSqlQueryTest.cs (67) : database.AddTable(tabla);
MiniSqlQueryTest.cs (68) : DropTable dropTableQuery = new DropTable("Usuarios");
MiniSqlQueryTest.cs (71) : string resultado = dropTableQuery.Execute(database);
MiniSqlQueryTest.cs (74) : Assert.Equal(Constants.DropTableSuccess, resultado);
MiniSqlQueryTest.cs (75) : }
MiniSqlQueryTest.cs (77) : [Fact]
MiniSqlQueryTest.cs (78) : public void DropTableTablaInexistente()
MiniSqlQueryTest.cs (79) : {
MiniSqlQueryTest.cs (81) : Database database = new Database(Database.AdminUsername, Database.AdminPassword);
MiniSqlQueryTest.cs (82) : DropTable dropTableQuery = new DropTable("TablaInexistente");
MiniSqlQueryTest.cs (85) : string resultado = dropTableQuery.Execute(database);
MiniSqlQueryTest.cs (88) : Assert.Equal(Constants.TableDoesNotExistError, resultado);
MiniSqlQueryTest.cs (89) : }
MiniSqlQueryTest.cs (92) : }
MiniSqlQueryTest.cs (93) : }
PermissionsTest.cs (1) : ﻿using System;
PermissionsTest.cs (2) : using System.Collections.Generic;
PermissionsTest.cs (3) : using System.Linq;
PermissionsTest.cs (4) : using System.Text;
PermissionsTest.cs (5) : using System.Threading.Tasks;
PermissionsTest.cs (6) : using DbManager.Security;
PermissionsTest.cs (7) : using DbManager;
PermissionsTest.cs (8) : namespace OurTests
PermissionsTest.cs (9) : {
PermissionsTest.cs (10) : public class PermissionsTest
PermissionsTest.cs (11) : {
PermissionsTest.cs (12) : [Fact]
PermissionsTest.cs (13) : public void UsuarioNoAdminNoPuedeOtorgarPrivilegios()
PermissionsTest.cs (14) : {
PermissionsTest.cs (15) : Database db = new Database("usuario", "password");
PermissionsTest.cs (18) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilnoadmin");
PermissionsTest.cs (19) : db.ExecuteMiniSQLQuery("ADD USER (usuarionoadmin,password,perfilnoadmin)");
PermissionsTest.cs (20) : db.Save("BD_Privilegios");
PermissionsTest.cs (22) : Database dbNoAdmin = Database.Load("BD_Privilegios", "usuarionoadmin", "password");
PermissionsTest.cs (24) : string resultado = dbNoAdmin.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilnoadmin");
PermissionsTest.cs (26) : Assert.NotNull(resultado);
PermissionsTest.cs (27) : Assert.Equal(Constants.UsersProfileIsNotGrantedRequiredPrivilege, resultado);
PermissionsTest.cs (28) : }
PermissionsTest.cs (31) : [Fact]
PermissionsTest.cs (32) : public void AdminPuedeOtorgarPrivilegio()
PermissionsTest.cs (33) : {
PermissionsTest.cs (34) : Database db = new Database("usuario", "password");
PermissionsTest.cs (36) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTest.cs (37) : db.ExecuteMiniSQLQuery("ADD USER (usuarioNoAdmin,password,perfilNoAdmin)");
PermissionsTest.cs (39) : string resultado = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTest.cs (41) : Assert.NotNull(resultado);
PermissionsTest.cs (42) : Assert.Equal(Constants.GrantPrivilegeSuccess, resultado);
PermissionsTest.cs (43) : }
PermissionsTest.cs (45) : [Fact]
PermissionsTest.cs (46) : public void NoSePuedeOtorgarDosVecesElMismoPrivilegio()
PermissionsTest.cs (47) : {
PermissionsTest.cs (48) : Database db = new Database("usuario", "password");
PermissionsTest.cs (50) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTest.cs (51) : db.ExecuteMiniSQLQuery("ADD USER (usuarioNoAdmin,password,perfilNoAdmin)");
PermissionsTest.cs (52) : db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTest.cs (54) : string resultado = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfilNoAdmin");
PermissionsTest.cs (56) : Assert.NotNull(resultado);
PermissionsTest.cs (57) : Assert.Equal(Constants.ProfileAlreadyHasPrivilege, resultado);
PermissionsTest.cs (58) : }
PermissionsTest.cs (60) : [Fact]
PermissionsTest.cs (61) : public void PerfilPuedeTenerMultiplesPrivilegios()
PermissionsTest.cs (62) : {
PermissionsTest.cs (63) : Database db = new Database("admin", "adminpass");
PermissionsTest.cs (65) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfil");
PermissionsTest.cs (67) : string r1 = db.ExecuteMiniSQLQuery("GRANT SELECT ON tabla1 TO perfil");
PermissionsTest.cs (68) : string r2 = db.ExecuteMiniSQLQuery("GRANT INSERT ON tabla2 TO perfil");
PermissionsTest.cs (70) : Assert.Equal(Constants.GrantPrivilegeSuccess, r1);
PermissionsTest.cs (71) : Assert.Equal(Constants.GrantPrivilegeSuccess, r2);
PermissionsTest.cs (72) : }
PermissionsTest.cs (74) : [Fact]
PermissionsTest.cs (75) : public void AdminPuedeAnularPrivilegio()
PermissionsTest.cs (76) : {
PermissionsTest.cs (77) : Database db = new Database("admin", "adminpass");
PermissionsTest.cs (79) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfil");
PermissionsTest.cs (80) : db.ExecuteMiniSQLQuery("GRANT DELETE ON tabla1 TO perfil");
PermissionsTest.cs (82) : string resultado = db.ExecuteMiniSQLQuery("REVOKE DELETE ON tabla1 TO perfil");
PermissionsTest.cs (84) : Assert.Equal(Constants.RevokePrivilegeSuccess, resultado);
PermissionsTest.cs (85) : }
PermissionsTest.cs (87) : [Fact]
PermissionsTest.cs (88) : public void UsuarioNoAdminNoPuedeAnularPrivilegios()
PermissionsTest.cs (89) : {
PermissionsTest.cs (90) : Database db = new Database("admin", "adminpass");
PermissionsTest.cs (92) : db.ExecuteMiniSQLQuery("CREATE SECURITY PROFILE perfilNoAdmin");
PermissionsTest.cs (93) : db.ExecuteMiniSQLQuery("ADD USER(usuario,password,perfilNoAdmin)");
PermissionsTest.cs (94) : db.Save("BD_RevokeTest");
PermissionsTest.cs (96) : Database dbNoAdmin = Database.Load("BD_RevokeTest", "usuario", "password");
PermissionsTest.cs (99) : string resultado = dbNoAdmin.ExecuteMiniSQLQuery("REVOKE INSERT ON tabla1 TO perfilNoAdmin");
PermissionsTest.cs (101) : Assert.Equal(Constants.UsersProfileIsNotGrantedRequiredPrivilege, resultado);
PermissionsTest.cs (102) : }
PermissionsTest.cs (106) : }
PermissionsTest.cs (107) : }
RowTests.cs (13) : public void TestGetSetValue()
RowTests.cs (29) : rowPrueba.SetValue("peso", "123");
RowTests.cs (30) : Assert.Equal("casados", rowPrueba.GetValue("casa"));
RowTests.cs (31) : Assert.Equal("123", rowPrueba.GetValue("peso"));
RowTests.cs (32) : rowPrueba.SetValue("peso", "128");
RowTests.cs (33) : Assert.Equal("128", rowPrueba.GetValue("peso"));
RowTests.cs (39) : [Fact]
RowTests.cs (40) : public void IsTrue_ReturnsTrue()
RowTests.cs (41) : {
RowTests.cs (43) : var columns = new List<ColumnDefinition>
RowTests.cs (44) : {
RowTests.cs (45) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad"),
RowTests.cs (46) : new ColumnDefinition(ColumnDefinition.DataType.String, "Peso")
RowTests.cs (47) : };
RowTests.cs (49) : var valuesTrue = new List<string> { "25", "80" };
RowTests.cs (50) : var rowTrue = new Row(columns, valuesTrue);
RowTests.cs (51) : var condition1 = new Condition("Edad", "=", "25");
RowTests.cs (52) : var condition2 = new Condition("Edad", "<", "26");
RowTests.cs (54) : bool result1 = rowTrue.IsTrue(condition1);
RowTests.cs (55) : bool result2 = rowTrue.IsTrue(condition2);
RowTests.cs (58) : Assert.Equal(result1,true);
RowTests.cs (59) : Assert.Equal(result2, true);
RowTests.cs (63) : var columnsFalse = new List<ColumnDefinition>
RowTests.cs (64) : {
RowTests.cs (65) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad"),
RowTests.cs (66) : new ColumnDefinition(ColumnDefinition.DataType.String, "Peso")
RowTests.cs (67) : };
RowTests.cs (69) : var valuesFalse = new List<string> { "25", "80" };
RowTests.cs (70) : var rowFalse = new Row(columnsFalse, valuesFalse);
RowTests.cs (71) : var conditionFalse = new Condition("Age", ">", "20");
RowTests.cs (74) : bool resultFalse = rowFalse.IsTrue(conditionFalse);
RowTests.cs (76) : Assert.Equal(resultFalse,false);
RowTests.cs (79) : var columnsStringTrue = new List<ColumnDefinition>
RowTests.cs (80) : {
RowTests.cs (82) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre")
RowTests.cs (83) : };
RowTests.cs (85) : var valuesStringTrue = new List<string> { "Mik" };
RowTests.cs (86) : var rowStringTrue = new Row(columnsStringTrue, valuesStringTrue);
RowTests.cs (87) : var conditionStringTrue = new Condition("Nombre", ">", "Aca");
RowTests.cs (91) : bool resultStringTrue = rowStringTrue.IsTrue(conditionStringTrue);
RowTests.cs (93) : Assert.Equal(resultStringTrue, true);
RowTests.cs (97) : }
RowTests.cs (99) : [Fact]
RowTests.cs (100) : public void AsTextEncodeTest()
RowTests.cs (101) : {
RowTests.cs (102) : var columns = new List<ColumnDefinition>
RowTests.cs (103) : {
RowTests.cs (104) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
RowTests.cs (105) : new ColumnDefinition(ColumnDefinition.DataType.String, "Apellido"),
RowTests.cs (106) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad")
RowTests.cs (107) : };
RowTests.cs (109) : var values1 = new List<string> { "Carlos", "C:Mary", "30" };
RowTests.cs (110) : var row1 = new Row(columns, values1);
RowTests.cs (111) : string expected1 = "Carlos:C[SEPARATOR]Mary:30";
RowTests.cs (112) : Assert.Equal(expected1, row1.AsText());
RowTests.cs (115) : var values2 = new List<string> { "La", "Oreja:De:Van:Gogh", "25" };
RowTests.cs (116) : var row2 = new Row(columns, values2);
RowTests.cs (117) : string expected2 = "La:Oreja[SEPARATOR]De[SEPARATOR]Van[SEPARATOR]Gogh:25";
RowTests.cs (118) : Assert.Equal(expected2, row2.AsText());
RowTests.cs (121) : var values3 = new List<string> { "Pedro", "S�nchez", "40" };
RowTests.cs (122) : var row3 = new Row(columns, values3);
RowTests.cs (123) : string expected3 = "Pedro:S�nchez:40";
RowTests.cs (124) : Assert.Equal(expected3, row3.AsText());
RowTests.cs (127) : var row4 = new Row(columns, new List<string>());
RowTests.cs (128) : string expected4 = "";
RowTests.cs (129) : Assert.Equal(expected4, row4.AsText());
RowTests.cs (132) : var values5 = new List<string> { "�nicoValor" };
RowTests.cs (133) : var row5 = new Row(new List<ColumnDefinition> { new ColumnDefinition(ColumnDefinition.DataType.String, "Campo") }, values5);
RowTests.cs (134) : string expected5 = "�nicoValor";
RowTests.cs (135) : Assert.Equal(expected5, row5.AsText());
RowTests.cs (138) : var values6 = new List<string> { "Duki", "", "50" };
RowTests.cs (139) : var row6 = new Row(columns, values6);
RowTests.cs (140) : string expected6 = "Duki::50";
RowTests.cs (141) : Assert.Equal(expected6, row6.AsText());
RowTests.cs (142) : }
RowTests.cs (144) : [Fact]
RowTests.cs (145) : public void ParseRowTest()
RowTests.cs (146) : {
RowTests.cs (147) : var columns = new List<ColumnDefinition>
RowTests.cs (148) : {
RowTests.cs (149) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
RowTests.cs (150) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad"),
RowTests.cs (151) : new ColumnDefinition(ColumnDefinition.DataType.Double, "Salario")
RowTests.cs (152) : };
RowTests.cs (154) : string rowText = "Carlos:30:2500.5";
RowTests.cs (155) : var row = Row.Parse(columns, rowText);
RowTests.cs (157) : Assert.Equal("Carlos", row.GetValue("Nombre"));
RowTests.cs (158) : Assert.Equal("30", row.GetValue("Edad"));
RowTests.cs (159) : Assert.Equal("2500.5", row.GetValue("Salario"));
RowTests.cs (160) : Assert.Equal(rowText, row.AsText());
RowTests.cs (162) : string rowTextWithEncoded = "Ana[SEPARATOR]Maria:28:3000";
RowTests.cs (163) : var row2 = Row.Parse(columns, rowTextWithEncoded);
RowTests.cs (164) : Assert.Equal("Ana:Maria", row2.GetValue("Nombre"));
RowTests.cs (165) : Assert.Equal("28", row2.GetValue("Edad"));
RowTests.cs (166) : Assert.Equal("3000", row2.GetValue("Salario"));
RowTests.cs (167) : Assert.Equal(rowTextWithEncoded, row2.AsText());
RowTests.cs (168) : }
RowTests.cs (170) : [Fact]
RowTests.cs (171) : public void TablaConColumnasPeroSinFilas()
RowTests.cs (172) : {
RowTests.cs (174) : List<ColumnDefinition> columnas = new List<ColumnDefinition>
RowTests.cs (175) : {
RowTests.cs (176) : new ColumnDefinition(ColumnDefinition.DataType.String, "Nombre"),
RowTests.cs (177) : new ColumnDefinition(ColumnDefinition.DataType.Int, "Edad"),
RowTests.cs (178) : new ColumnDefinition(ColumnDefinition.DataType.Double, "Altura")
RowTests.cs (179) : };
RowTests.cs (181) : Table tabla = new Table("TestTable", columnas);
RowTests.cs (184) : string resultado = tabla.ToString();
RowTests.cs (187) : string esperado = "['Nombre','Edad','Altura']";
RowTests.cs (188) : Assert.Equal(esperado, resultado);
RowTests.cs (189) : }
SecurityClassMethodTests.cs (1) : ﻿using System;
SecurityClassMethodTests.cs (2) : using System.Collections.Generic;
SecurityClassMethodTests.cs (3) : using System.Linq;
SecurityClassMethodTests.cs (4) : using System.Text;
SecurityClassMethodTests.cs (5) : using System.Threading.Tasks;
SecurityClassMethodTests.cs (6) : using DbManager.Security;
SecurityClassMethodTests.cs (7) : using DbManager;
SecurityClassMethodTests.cs (9) : namespace OurTests
SecurityClassMethodTests.cs (10) : {
SecurityClassMethodTests.cs (11) : public class SecurityClassMethodTests
SecurityClassMethodTests.cs (12) : {
SecurityClassMethodTests.cs (13) : [Fact]
SecurityClassMethodTests.cs (14) : public void AñadeUsuarioCorrectamente()
SecurityClassMethodTests.cs (15) : {
SecurityClassMethodTests.cs (16) : var db = Database.CreateTestDatabase();
SecurityClassMethodTests.cs (17) : var perfil = new Profile { Name = "Default" };
SecurityClassMethodTests.cs (18) : db.SecurityManager.Profiles.Add(perfil);
SecurityClassMethodTests.cs (20) : var consulta = new AddUser("nuevoUsuario", "contraseña123", "Default");
SecurityClassMethodTests.cs (21) : string resultado = consulta.Execute(db);
SecurityClassMethodTests.cs (23) : Assert.Equal(Constants.AddUserSuccess, resultado);
SecurityClassMethodTests.cs (24) : Assert.Contains(perfil.Users, u => u.Username == "nuevoUsuario");
SecurityClassMethodTests.cs (25) : }
SecurityClassMethodTests.cs (28) : [Fact]
SecurityClassMethodTests.cs (29) : public void NoAñadeUsuario_SiElPerfilNoExiste()
SecurityClassMethodTests.cs (30) : {
SecurityClassMethodTests.cs (31) : var db = Database.CreateTestDatabase();
SecurityClassMethodTests.cs (33) : var consulta = new AddUser("usuario", "pass", "Inexistente");
SecurityClassMethodTests.cs (34) : string resultado = consulta.Execute(db);
SecurityClassMethodTests.cs (36) : Assert.Equal(Constants.SecurityProfileDoesNotExistError, resultado);
SecurityClassMethodTests.cs (37) : }
SecurityClassMethodTests.cs (42) : }
SecurityClassMethodTests.cs (43) : }
AddUser.cs (5) : using DbManager.Security;
AddUser.cs (20) : this.Username = username;
AddUser.cs (21) : this.Password = password;
AddUser.cs (22) : this.ProfileName = profileName;
AddUser.cs (30) : /*if (!database.IsUserAdmin())
AddUser.cs (31) : {
AddUser.cs (32) : return Constants.UsersProfileIsNotGrantedRequiredPrivilege;
AddUser.cs (33) : }
AddUser.cs (35) : var profile = database.SecurityManager.ProfileByName(ProfileName);
AddUser.cs (36) : if (profile == null)
AddUser.cs (37) : {
AddUser.cs (38) : return Constants.SecurityProfileDoesNotExistError;
AddUser.cs (39) : }
AddUser.cs (40) : foreach (var user in profile.Users)
AddUser.cs (41) : {
AddUser.cs (42) : if (user.Username == Username)
AddUser.cs (43) : {
AddUser.cs (44) : return "El usuario ya existe en este perfil";
AddUser.cs (45) : }
AddUser.cs (46) : }
AddUser.cs (48) : User newUser = new User(Username, Password);
AddUser.cs (50) : profile.Users.Add(newUser);
AddUser.cs (52) : return Constants.AddUserSuccess;*/
AddUser.cs (55) : var security = database.SecurityManager;
AddUser.cs (57) : if (security == null || !security.IsUserAdmin())
AddUser.cs (58) : {
AddUser.cs (59) : return Constants.UsersProfileIsNotGrantedRequiredPrivilege;
AddUser.cs (60) : }
AddUser.cs (62) : var targetProfile = security.ProfileByName(ProfileName);
AddUser.cs (63) : if (targetProfile == null)
AddUser.cs (64) : {
AddUser.cs (65) : return Constants.SecurityProfileDoesNotExistError;
AddUser.cs (68) : bool userExists = targetProfile.Users.Exists(delegate (User user)
AddUser.cs (69) : {
AddUser.cs (70) : return string.Equals(user.Username, Username);
AddUser.cs (71) : });
AddUser.cs (73) : if (userExists)
AddUser.cs (74) : {
AddUser.cs (75) : return Constants.Error + "User already exists";
AddUser.cs (76) : }
AddUser.cs (78) : User userToAdd = new User(Username, Password);
AddUser.cs (79) : targetProfile.Users.Add(userToAdd);
AddUser.cs (81) : return Constants.AddUserSuccess;
AddUser.cs (82) : }
CreateSecurityProfile.cs (5) : using DbManager.Security;
CreateSecurityProfile.cs (40) : Manager manager = database.SecurityManager;
CreateSecurityProfile.cs (42) : if (manager.IsUserAdmin())
CreateSecurityProfile.cs (43) : {
CreateSecurityProfile.cs (44) : manager.AddProfile(new Profile { Name = ProfileName });
CreateSecurityProfile.cs (46) : return Constants.CreateSecurityProfileSuccess;
CreateSecurityProfile.cs (47) : }
CreateSecurityProfile.cs (49) : return Constants.UsersProfileIsNotGrantedRequiredPrivilege;
CreateTable.cs (16) : //TODO
CreateTable.cs (17) : //: Initialize member variables
DeleteUser.cs (25) : var securityManager = database.SecurityManager;
DeleteUser.cs (27) : if (securityManager == null || !securityManager.IsUserAdmin())
DeleteUser.cs (28) : {
DeleteUser.cs (29) : return Constants.UsersProfileIsNotGrantedRequiredPrivilege;
DeleteUser.cs (30) : }
DeleteUser.cs (32) : Profile profileWithUser = null;
DeleteUser.cs (34) : foreach (var profile in securityManager.Profiles)
DeleteUser.cs (35) : {
DeleteUser.cs (36) : foreach (var user in profile.Users)
DeleteUser.cs (37) : {
DeleteUser.cs (38) : if (user.Username == Username)
DeleteUser.cs (39) : {
DeleteUser.cs (40) : profileWithUser = profile;
DeleteUser.cs (41) : break;
DeleteUser.cs (42) : }
DeleteUser.cs (43) : }
DeleteUser.cs (45) : if (profileWithUser != null)
DeleteUser.cs (46) : break;
DeleteUser.cs (47) : }
DeleteUser.cs (49) : if (profileWithUser == null)
DeleteUser.cs (50) : {
DeleteUser.cs (51) : return Constants.UserDoesNotExistError;
DeleteUser.cs (52) : }
DeleteUser.cs (54) : User userToRemove = null;
DeleteUser.cs (55) : foreach (var user in profileWithUser.Users)
DeleteUser.cs (56) : {
DeleteUser.cs (57) : if (user.Username == Username)
DeleteUser.cs (58) : {
DeleteUser.cs (59) : userToRemove = user;
DeleteUser.cs (60) : break;
DeleteUser.cs (61) : }
DeleteUser.cs (62) : }
DeleteUser.cs (64) : if (userToRemove != null)
DeleteUser.cs (65) : {
DeleteUser.cs (66) : profileWithUser.Users.Remove(userToRemove);
DeleteUser.cs (67) : return Constants.DeleteUserSuccess;
DeleteUser.cs (68) : }
DeleteUser.cs (70) : return Constants.UserDoesNotExistError;
DropSecurityProfile.cs (24) : Manager manager = database.SecurityManager;
DropSecurityProfile.cs (26) : if (!manager.IsUserAdmin())
DropSecurityProfile.cs (28) : return Constants.UsersProfileIsNotGrantedRequiredPrivilege;
DropSecurityProfile.cs (31) : bool profileExists = false;
DropSecurityProfile.cs (33) : foreach (Profile profile in manager.Profiles)
DropSecurityProfile.cs (34) : {
DropSecurityProfile.cs (35) : if (profile.Name == ProfileName)
DropSecurityProfile.cs (36) : {
DropSecurityProfile.cs (37) : profileExists = true;
DropSecurityProfile.cs (38) : break;
DropSecurityProfile.cs (39) : }
DropSecurityProfile.cs (40) : }
DropSecurityProfile.cs (42) : if (!profileExists)
DropSecurityProfile.cs (43) : {
DropSecurityProfile.cs (44) : return Constants.SecurityProfileDoesNotExistError;
DropSecurityProfile.cs (45) : }
DropSecurityProfile.cs (47) : manager.RemoveProfile(ProfileName);
DropSecurityProfile.cs (48) : return Constants.DropSecurityProfileSuccess;
DropTable.cs (23) : Table table = database.TableByName(Table);
DropTable.cs (24) : if (table == null)
DropTable.cs (25) : {
DropTable.cs (26) : return Constants.TableDoesNotExistError;
DropTable.cs (27) : }
DropTable.cs (28) : bool success = database.DropTable(Table);
DropTable.cs (29) : if (success)
DropTable.cs (30) : {
DropTable.cs (31) : return Constants.DropTableSuccess;
DropTable.cs (32) : }
DropTable.cs (34) : return Constants.Error;
Grant.cs (20) : this.PrivilegeName = privilegeName;
Grant.cs (21) : this.TableName = tableName;
Grant.cs (22) : this.ProfileName = profileName;
Grant.cs (29) : if (database.SecurityManager == null || !database.SecurityManager.IsUserAdmin())
Grant.cs (35) : Profile profile = database.SecurityManager.ProfileByName(ProfileName);
Grant.cs (42) : if (!Enum.TryParse(PrivilegeName, true, out Privilege privilege))
Grant.cs (43) : {
Grant.cs (45) : }
Grant.cs (48) : if (profile.IsGrantedPrivilege(TableName, privilege))
Grant.cs (49) : {
Grant.cs (50) : return Constants.ProfileAlreadyHasPrivilege;
Grant.cs (51) : }
Grant.cs (54) : profile.GrantPrivilege(TableName, privilege);
Insert.cs (27) : Table table = database.TableByName(Table);
Insert.cs (28) : if (table == null)
Insert.cs (29) : {
Insert.cs (30) : return Constants.TableDoesNotExistError;
Insert.cs (31) : }
Insert.cs (34) : bool success = database.Insert(Table, Values);
Insert.cs (37) : if (success)
Insert.cs (38) : {
Insert.cs (39) : return Constants.InsertSuccess;
Insert.cs (40) : }
Insert.cs (41) : return Constants.ColumnCountsDontMatch;
Revoke.cs (5) : using DbManager.Security;
Revoke.cs (30) : if (database.SecurityManager.IsUserAdmin())
Revoke.cs (31) : {
Revoke.cs (32) : database.SecurityManager.ProfileByName(ProfileName).RevokePrivilege(TableName, PrivilegeUtils.FromPrivilegeName(PrivilegeName));
Revoke.cs (34) : return Constants.RevokePrivilegeSuccess;
Revoke.cs (35) : }
Revoke.cs (37) : return Constants.Error;
Manager.cs (39) : string encrypted = Encryption.Encrypt(password);
Manager.cs (47) : return encrypted == u.EncryptedPassword;
Manager.cs (170) : string databasePath = Path.Combine(Directory.GetCurrentDirectory(), databaseName);
Manager.cs (172) : if (!Directory.Exists(databasePath))
Manager.cs (173) : {
Manager.cs (174) : Console.WriteLine("Database does not exist");
Manager.cs (175) : return null;
Manager.cs (176) : }
Manager.cs (178) : string[] profileFiles = Directory.GetFiles(databasePath, "*.profile");
Manager.cs (179) : if (profileFiles.Length == 0)
Manager.cs (180) : {
Manager.cs (181) : Console.WriteLine("No profiles found in database");
Manager.cs (182) : return null;
Manager.cs (183) : }
Manager.cs (185) : Manager result = new Manager(username);
Manager.cs (187) : foreach (string filePath in profileFiles)
Manager.cs (188) : {
Manager.cs (189) : string profileName = Path.GetFileNameWithoutExtension(filePath);
Manager.cs (191) : using (StreamReader reader = new StreamReader(filePath))
Manager.cs (192) : {
Manager.cs (193) : try
Manager.cs (194) : {
Manager.cs (195) : List<string> names = new List<string>();
Manager.cs (196) : List<string> passwords = new List<string>();
Manager.cs (198) : string usersLine = reader.ReadLine();
Manager.cs (199) : int startPosition = usersLine.IndexOf("]") + 1;
Manager.cs (200) : usersLine = usersLine.Substring(startPosition);
Manager.cs (202) : string[] entries = usersLine.Split(new[] { "}" }, StringSplitOptions.RemoveEmptyEntries);
Manager.cs (203) : foreach (string entry in entries)
Manager.cs (204) : {
Manager.cs (205) : string cleanEntry = entry.Replace("{", "").Replace("'", "").Trim();
Manager.cs (206) : string[] parts = cleanEntry.Split(',');
Manager.cs (208) : if (parts.Length == 2)
Manager.cs (209) : {
Manager.cs (210) : names.Add(parts[0]);
Manager.cs (211) : passwords.Add(parts[1]);
Manager.cs (212) : }
Manager.cs (213) : }
Manager.cs (215) : Profile profile = new Profile { Name = profileName };
Manager.cs (217) : for (int j = 0; j < names.Count; j++)
Manager.cs (218) : {
Manager.cs (219) : var user = new User("temp", "temp");
Manager.cs (220) : user.Username = names[j];
Manager.cs (221) : user.EncryptedPassword = passwords[j];
Manager.cs (222) : profile.Users.Add(user);
Manager.cs (223) : }
Manager.cs (225) : string privilegesLine = reader.ReadLine();
Manager.cs (226) : entries = privilegesLine.Split(new[] { "}" }, StringSplitOptions.RemoveEmptyEntries);
Manager.cs (228) : foreach (string entry in entries)
Manager.cs (229) : {
Manager.cs (230) : string cleanEntry = entry.Replace("{", "").Replace("'", "").Trim();
Manager.cs (231) : string[] parts = cleanEntry.Split(',');
Manager.cs (233) : if (parts.Length >= 2)
Manager.cs (234) : {
Manager.cs (235) : string tableName = parts[0];
Manager.cs (236) : for (int j = 1; j < parts.Length; j++)
Manager.cs (237) : {
Manager.cs (238) : if (Enum.TryParse(parts[j], true, out Privilege privilege))
Manager.cs (239) : {
Manager.cs (240) : profile.GrantPrivilege(tableName, privilege);
Manager.cs (241) : }
Manager.cs (242) : }
Manager.cs (243) : }
Manager.cs (244) : }
Manager.cs (246) : result.AddProfile(profile);
Manager.cs (247) : }
Manager.cs (248) : catch (Exception ex)
Manager.cs (249) : {
Manager.cs (250) : Console.WriteLine("Error reading profile: " + ex.Message);
Manager.cs (251) : }
Manager.cs (252) : }
Manager.cs (253) : }
Manager.cs (255) : return result.UserByName(username) == null ? null : result;
Manager.cs (261) : try
Manager.cs (262) : {
Manager.cs (263) : foreach (var profile in Profiles)
Manager.cs (264) : {
Manager.cs (265) : string filePath = Path.Combine(databaseName, profile.Name + ".profile");
Manager.cs (266) : using (StreamWriter writer = new StreamWriter(filePath))
Manager.cs (267) : {
Manager.cs (268) : writer.WriteLine(profile.ToString());
Manager.cs (269) : writer.WriteLine(profile.WritePrivileges());
Manager.cs (270) : }
Manager.cs (271) : }
Manager.cs (272) : }
Manager.cs (273) : catch (Exception ex)
Manager.cs (274) : {
Manager.cs (275) : Console.WriteLine("Error al guardar perfiles: " + ex.Message);
Manager.cs (276) : }
Profile.cs (21) : if (string.IsNullOrWhiteSpace(table))
Profile.cs (22) : return false;
Profile.cs (24) : List<Privilege> privileges;
Profile.cs (25) : if (!PrivilegesOn.TryGetValue(table, out privileges))
Profile.cs (27) : privileges = new List<Privilege>();
Profile.cs (28) : PrivilegesOn.Add(table, privileges);
Profile.cs (31) : if (privileges.IndexOf(privilege) == -1)
Profile.cs (33) : privileges.Add(privilege);
Profile.cs (46) : if (string.IsNullOrEmpty(table) || !PrivilegesOn.ContainsKey(table)) return false;
Profile.cs (48) : if (PrivilegesOn[table].Contains(privilege))
Profile.cs (50) : PrivilegesOn[table].Remove(privilege);
Profile.cs (51) : if (PrivilegesOn[table].Count == 0)
Profile.cs (66) : if (Name == AdminProfileName)
Profile.cs (67) : return true;
Profile.cs (69) : return PrivilegesOn.ContainsKey(table) && PrivilegesOn[table].Contains(privilege);
Profile.cs (71) : public String WritePrivileges()
Profile.cs (72) : {
Profile.cs (73) : String result = "";
Profile.cs (75) : foreach (var entry in PrivilegesOn)
Profile.cs (76) : {
Profile.cs (77) : result += "{'" + entry.Key + "'";
Profile.cs (79) : for (int i = 0; i < entry.Value.Count; i++)
Profile.cs (80) : {
Profile.cs (81) : result += ",'" + entry.Value[i] + "'";
Profile.cs (82) : }
Profile.cs (84) : result += "}";
Profile.cs (85) : }
Profile.cs (87) : return result;
Profile.cs (88) : }
